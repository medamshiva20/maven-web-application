name: Azure Pipeline
#variables:
#- group: customer1_vars
trigger:
- main
pool: 
 name: DevOps_Agent
stages:
- stage: CI
  jobs:
  - job: UseNodeVersion
    steps: 
    - task: NodeTool@0
      inputs:
        versionSource: 'spec'
        versionSpec: '14.x'
    - task: CmdLine@2
      displayName: Packages Installation
      inputs:
        script: |
          sudo apt-get update -y
          sudo apt install nodejs -y
          sudo apt-get install npm -y
          sudo apt-get install yarn -y
          npm --version
          node --version
          yarn --version
          pwd
          ls
          rm -rf dist
          rm -rf node_modules
          ls
          export VERSION=v4/
          export GRANYTYPE=password
          export REFRESHGRANTTYPE=refresh_token
          export ONESIGNALAPPID=4ba2c433-5984-42db-8840-c8fca2e0c8cf
          export DEV_WEBAPIURL=https://app-dev-sre.helixsense.com
          export GOOGLE_API_KEY=AIzaSyAJ1Ra59I-yonhcvV3BbyaI-ayzFyaXW5Y
          export GOOGLE_CAPTCHA_SITE_KEY=6LfzYzUfAAAAADFX4l4BMj2hzXVxf30aPXoTaoQP
          export GOOGLE_CAPTCHA_SECRET_KEY=6LfzYzUfAAAAADQ_aoQLU8_8NRaCsIY5kQj876Gq
          export NODE_OPTIONS=--max_old_space_size=4096
          export REACT_APP_WEB_URL=https://app-dev-sre.helixsense.com
          export WEBAPIURL=https://app-dev-sre.helixsense.com
          export CLIENT_NAME=default
          export ENV=dev
          export IS_USE_APIGATEWAY=false
          export MUI_LICENSE_KEY=5409103c3309cabaa7a20e98f6a3965cTz01NDA0MixFPTE2OTk2MDE2NDk0OTAsUz1wcm8sTE09c3Vic2NyaXB0aW9uLEtWPTI=
    - task: CmdLine@2
      displayName: Executing yarn
      inputs:
        script: | 
            yarn
            yarn run dev --env.CLIENT_NAME=sfx
            pwd
            ls
            echo "Removing existing dev package directory"
            rm -rf dev
            ls
            echo "creating new dev package directory"
            mkdir dev
            cp -r dist ./dev 
            cp /home/motivity/_work/node_modules/vso-task-lib/package.json server.js powerBi.js ./dev
            cp -r /home/motivity/_work/node_modules/vso-task-lib/node_modules/ ./dev
            cp -r jumpcloud ./dev
            echo "Listing contents of New Environment"
            ls ./dev
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'hlx_nodejs'
        publishLocation: 'Container'
   # - task: Bash@3
   #   inputs:
   #     targetType: 'inline'
   #     script: |
   #       # Write your commands here
   #       zip hlx_nodejs-artifact.zip hlx_nodejs